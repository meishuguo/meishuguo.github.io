<!DOCTYPE html>
<!--[if lte IE 8 ]>
<html class="ie" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<![endif]-->
<!--[if (gte IE 9)|!(IE)]><!-->
<!--
***************  *      *     *
      8          *    *       *
      8          *  *         *
      8          **           *
      8          *  *         *
      8          *    *       *
      8          *      *     *
      8          *        *   ***********    -----Theme By Kieran(http://go.kieran.top)
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<!--<![endif]-->

<head>
  <title>meishuguo</title>
  <!-- Meta data -->
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content="meishuguo">
    <meta name="author" content="YuanGuo">
    <meta name="description" content="" />
    <meta name="keywords" content="" />

    <!-- Favicon, (keep icon in root folder) -->
    <link rel="Shortcut Icon" href="/img/favicon.ico" type="image/ico">

    <link rel="alternate" href="/atom.xml" title="meishuguo" type="application/atom+xml">
    <link rel="stylesheet" href="/css/all.css" media="screen" type="text/css">
    
    <link rel="stylesheet" href="/highlightjs/vs.css" type="text/css">
    

    <!--[if IE 8]>
    <link rel="stylesheet" type="text/css" href="/css/ie8.css" />
    <![endif]-->

    <!-- jQuery | Load our jQuery, with an alternative source fallback to a local version if request is unavailable -->
    <script src="/js/jquery-1.11.1.min.js"></script>
    <script>window.jQuery || document.write('<script src="js/jquery-1.11.1.min.js"><\/script>')</script>

    <!-- Load these in the <head> for quicker IE8+ load times -->
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="/js/html5shiv.min.js"></script>
    <script src="/js/respond.min.js"></script>
    <![endif]-->

  
  
  

  <style>.col-md-8.col-md-offset-2.opening-statement img{display:none;}</style>
</head>

<!--
<body class="post-template">
-->
<body id="index" class="lightnav animsition">

      <!-- ============================ Off-canvas navigation =========================== -->

    <div class="sb-slidebar sb-right sb-style-overlay sb-momentum-scrolling">
        <div class="sb-close" aria-label="Close Menu" aria-hidden="true">
            <img src="/img/close.png" alt="Close"/>
        </div>
        <!-- Lists in Slidebars -->
        <ul class="sb-menu">
            <li><a href="/" class="animsition-link" title="Home">Home</a></li>
            <li><a href="/archives" class="animsition-link" title="archive">archives</a></li>
            <!-- Dropdown Menu -->
			 
            <li>
                <a class="sb-toggle-submenu">Works<span class="sb-caret"></span></a>
                <ul class="sb-submenu">
                    
                        <li><a href="/" target="_BLANK" class="animsition-link">AAA</a></li>
                    
                        <li><a href="/atom.xml" target="_BLANK" class="animsition-link">BBB</a></li>
                    
                </ul>
            </li>
            
            
            
            <li>
                <a class="sb-toggle-submenu">Links<span class="sb-caret"></span></a>
                <ul class="sb-submenu">
                    
                    <li><a href="http://domain.com/" class="animsition-link">Name</a></li>
                    
                </ul>
            </li>
            
        </ul>
        <!-- Lists in Slidebars -->
        <ul class="sb-menu secondary">
            <li><a href="/about.html" class="animsition-link" title="about">About</a></li>
            <li><a href="/atom.xml" class="animsition-link" title="rss">RSS</a></li>
        </ul>
    </div>
    
    <!-- ============================ END Off-canvas navigation =========================== -->

    <!-- ============================ #sb-site Main Page Wrapper =========================== -->

    <div id="sb-site">
        <!-- #sb-site - All page content should be contained within this id, except the off-canvas navigation itself -->

        <!-- ============================ Header & Logo bar =========================== -->

        <div id="navigation" class="navbar navbar-fixed-top">
            <div class="navbar-inner">
                <div class="container">
                    <!-- Nav logo -->
                    <div class="logo">
                        <a href="/" title="Logo" class="animsition-link">
                         <img src="/img/logo.png" alt="Logo" width="35px;"/> 
                        </a>
                    </div>
                    <!-- // Nav logo -->
                    <!-- Info-bar -->
                    <nav>
                        <ul class="nav">
                            <li><a href="/" class="animsition-link">meishuguo</a></li>
                            <li class="nolink"><span>Always </span>Creative.</li>
                            
                            <li><a href="https://github.com/" title="Github" target="_blank"><i class="icon-github"></i></a></li>
                            
                            
                            <li><a href="https://twitter.com/" title="Twitter" target="_blank"><i class="icon-twitter"></i></a></li>
                            
                            
                            <li><a href="https://www.facebook.com/" title="Facebook" target="_blank"><i class="icon-facebook"></i></a></li>
                            
                            
                            <li><a href="https://google.com/" title="Google-Plus" target="_blank"><i class="icon-google-plus"></i></a></li>
                            
                            
                            <li><a href="http://weibo.com/" title="Sina-Weibo" target="_blank"><i class="icon-sina-weibo"></i></a></li>
                            
                            <li class="nolink"><span>Welcome!</span></li>
                        </ul>
                    </nav>
                    <!--// Info-bar -->
                </div>
                <!-- // .container -->
                <div class="learnmore sb-toggle-right">More</div>
                <button type="button" class="navbar-toggle menu-icon sb-toggle-right" title="More">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar before"></span>
                <span class="icon-bar main"></span>
                <span class="icon-bar after"></span>
                </button>
            </div>
            <!-- // .navbar-inner -->
        </div>

        <!-- ============================ Header & Logo bar =========================== -->


      
<section id="intro">
    <div class="container">
        <div class="row col-md-offset-2">
            <div class="col-md-8">
    			<span class="post-meta">
      <time datetime="2017-03-13T11:36:37.000Z" itemprop="datePublished">
          2017-03-13
      </time>
    
</span>
                <h1></h1>
            </div>
        </div>
        <div class="col-md-8 col-md-offset-2">
      		<p>[TOC]</p>
<hr>
<p>#项目主要内容<br> 课程主要实现运用机器学习的方法对一份血常规报告进行分析，主要实现性别和年龄的预测。<a href="http://teamtrac.ustcsz.edu.cn/wiki/NP2016" target="_blank" rel="external">NP2016</a></p>
<hr>
<p>#我的Pull Request</p>
<p> 1.<a href="https://coding.net/u/mengning/p/np2016/git/pull/40#pr-comment-62196" target="_blank" rel="external">ocr识别</a> pytesseract 调用 tesseract进行OCR识别【手工合并】<br> <img src="http://img.blog.csdn.net/20170103223341813?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvdTAxMDQ1NDQzOA==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"><br> 2.<a href="https://coding.net/u/mengning/p/np2016/git/pull/131" target="_blank" rel="external">数据处理</a>using numpy Organized into an easy-to-use format【已接受】<img src="http://img.blog.csdn.net/20170103223122955?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvdTAxMDQ1NDQzOA==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"><br>3.<a href="https://coding.net/u/mengning/p/np2016/git/pull/254" target="_blank" rel="external">LR和模型学习曲线</a>【未处理】</p>
<hr>
<p>#项目demo实现<br> <a href="https://coding.net/u/meishuguo/p/np2016/git" target="_blank" rel="external">版本库</a></p>
<p>##运行环境</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"># 安装numpy</div><div class="line">sudo apt-get install python-numpy # http://www.numpy.org/</div><div class="line"># 安装opencv</div><div class="line">sudo apt-get install python-opencv # http://opencv.org/</div><div class="line"></div><div class="line">##安装OCR和预处理相关依赖</div><div class="line">sudo apt-get install tesseract-ocr</div><div class="line">sudo pip install pytesseract</div><div class="line">sudo apt-get install python-tk</div><div class="line">sudo pip install pillow</div><div class="line"></div><div class="line"># 安装Flask框架、mongo</div><div class="line">sudo pip install Flask</div><div class="line">sudo apt-get install mongodb # 如果找不到可以先sudo apt-get update</div><div class="line">sudo service mongodb started</div><div class="line">sudo pip install pymongo</div><div class="line"></div><div class="line">#安装pandas和 scikit-learn</div><div class="line">sudo apt-get install python-numpy cython python-scipy python-matplotlib</div><div class="line">pip install -U scikit-learn(如果不行就加sudo)</div><div class="line">pip install pandas</div></pre></td></tr></table></figure>
<hr>
<p> ##项目说明</p>
<p> ###图像处理<br> A2主要完成的是如何将一张血常规报告单转换为可读训练数据。这是属于图像处理的内容。</p>
<p> 图像处理有两种方法，一种是传统的图像处理方法，运用图像的本身的颜色、几何、频域信息，做相关的变换提取信息，比如，用傅里叶变换提取频域信息去噪声，均值算子做平滑处理等；而另一种方法就是机器学习内容，最近很火的模仿梵高作画就是用这种方式实现的。在我看来，两者是相互促进的，深度学习的方法能够发现更好的算子，而传统方法能够使深度学习更加有效。<br> 不论使用哪种方法，都得理解图像的意义，对于深度学习做图像处理，只是提取了图像更多的信息，如果不理解图像本身，一顿瞎调参，是不太可能得到好的结果的</p>
<p> 这一部分是相当有挑战的内容，整个项目卡在这里有几天时间。</p>
<p> <strong>这部分我做的内容较少，在这里仅仅是记录下学习其他童鞋的处理方法。</strong></p>
<p> 先对整张图片做预处理。<br> <img src="http://img.blog.csdn.net/20170103005807430?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvdTAxMDQ1NDQzOA==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="血常规报告单"><br> <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">#灰度化</div><div class="line">img_gray = cv2.cvtColor(self.img, cv2.COLOR_BGR2GRAY)</div><div class="line">#高斯平滑</div><div class="line">img_gb = cv2.GaussianBlur(img_gray, (gb_param,gb_param), 0)</div><div class="line">#闭运算 </div><div class="line">closed = cv2.morphologyEx(img_gb, cv2.MORPH_CLOSE, kernel)</div><div class="line">#开运算</div><div class="line">opened = cv2.morphologyEx(closed, cv2.MORPH_OPEN, kernel)</div><div class="line">#canny算子边缘检测</div><div class="line">edges = cv2.Canny(opened, canny_param_lower , canny_param_upper)</div></pre></td></tr></table></figure></p>
<p> <img src="http://img.blog.csdn.net/20170103011259513?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvdTAxMDQ1NDQzOA==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"><br> 由于整张图有英文，中文，数字，符号等混杂在一起，所以要直接识别实现难度相当大。所以首先要对图片进行裁剪成单个的小方块。定位图片是关键。</p>
<p> 将黑线当作识别的特征</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"># 调用findContours提取轮廓</div><div class="line">contours, hierarchy = cv2.findContours(edges, cv2.RETR_TREE, cv2.CHAIN_APPROX_SIMPLE)</div><div class="line"># 求得最小外接矩形</div><div class="line">def getbox(i):</div><div class="line">rect = cv2.minAreaRect(contours[i])</div><div class="line">box = cv2.cv.BoxPoints(rect)</div><div class="line">box = np.int0(box)</div><div class="line">return box</div></pre></td></tr></table></figure>
<ul>
<li>比较最小外接矩形相邻两条边的长短</li>
<li>以两条短边的中点作为线的两端</li>
<li>所有的线两两进行比较筛选<br><img src="http://img.blog.csdn.net/20170103011012745?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvdTAxMDQ1NDQzOA==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="最小外接矩形"></li>
</ul>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"># 由三条线来确定表头的位置和表尾的位置</div><div class="line">line_upper, line_lower = findhead(line[2],line[1],line[0])</div><div class="line"></div><div class="line"># 由表头和表尾确定目标区域的位置</div><div class="line"></div><div class="line"># 利用叉乘的不可交换性确定起始点</div><div class="line">total_width = line_upper[1]-line_upper[0]</div><div class="line">total_hight = line_lower[0]-line_upper[0]</div><div class="line">cross_prod = cross(total_width, total_hight)</div><div class="line">if cross_prod &lt;0:</div><div class="line">temp = line_upper[1]</div><div class="line">line_upper[1] = line_upper[0]</div><div class="line">line_upper[0] = temp</div><div class="line">temp = line_lower[1]</div><div class="line">line_lower[1] = line_lower[0]</div><div class="line">line_lower[0] = temp</div></pre></td></tr></table></figure>
<p> 由于图像不肯能拍的完全正，所以进行<a href="http://blog.csdn.net/xiaowei_cqu/article/details/26471527" target="_blank" rel="external">透视变换</a></p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">#使用透视变换将表格区域转换为一个1000*760的图</div><div class="line">PerspectiveMatrix = cv2.getPerspectiveTransform(points,standard)</div><div class="line"></div><div class="line">self.PerspectiveImg = cv2.warpPerspective(self.img,PerspectiveMatrix, (1000, 760))</div></pre></td></tr></table></figure>
<p> 这样得到的图就是1000<em>760的相同大小图，能够进行裁剪成每个小方块。之后调用ocr识别库进行识别。就能够得到训练的数据。<br> <em>*由于血常规的字符有限，所以在用Tesseract做识别的时候可以规定自己的字典，这样不仅识别的速度够快，而且准确率能够得到保证。</em></em></p>
<hr>
<p> ###深度学习和机器学习<br> 这是本项目的数据处理部分，我在这方面做的工作主要有：</p>
<ul>
<li>对训练的数据进行了清洗整理</li>
<li>学习了深度学习的原理（虽然现在不能理解每一层代表什么用keras实现了一个3层的神经网络对性别和年龄进行预测）</li>
<li><p>逻辑斯特回归（用scikit-learn实现了年龄和性别的预测）。</p>
<p>数据整理</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">#表一</div><div class="line">sex	age	checkdate	shelfID</div><div class="line">男	1	5/7/2013	1</div><div class="line">男	1	12/11/2013	1</div><div class="line">男	1	12/13/2013	1</div><div class="line">男	1	1/15/2014	1</div><div class="line"></div><div class="line">#表二</div><div class="line">itemid	value1	checkdate	shelfid</div><div class="line">1	    5.2	    1/11/2013	91</div><div class="line">2	    4.53	1/11/2013	91</div><div class="line">3	    138	    1/11/2013	91</div><div class="line">4	   0.402	1/11/2013	91</div><div class="line">5	      89	1/11/2013	91</div></pre></td></tr></table></figure>
</li>
</ul>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">#去掉中间数据缺失的项和错误的项，仅保留26项的数据</div><div class="line">for row in csv_file2_object:</div><div class="line">if len(row[1])&lt;10 and int(row[0])&lt;=26:</div><div class="line">data_2.append(row)</div><div class="line">else:</div><div class="line">pass</div><div class="line">data2=np.array(data_2)</div><div class="line">col=0</div><div class="line">data2=data2[np.argsort(data2[:,col])]</div></pre></td></tr></table></figure>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">#对两表做连接操作，去掉项数不够的项。</div><div class="line">for row in csv_file1_object:</div><div class="line">right_only_stats= data2[(data2[0::,2]==row[2] ) &amp; (data2[0::,3]==row[3]),1]</div><div class="line">right_only_stats=</div><div class="line">np.insert(right_only_stats,0,values=i,axis=None)</div><div class="line">i=i+1</div><div class="line"></div><div class="line">right_only_stats=np.insert(</div><div class="line">right_only_stats,1,values=row[0],axis=None)</div><div class="line"></div><div class="line">right_only_stats,2,values=row[1],axis=None)</div><div class="line"></div><div class="line">if len(right_only_stats)==29:</div><div class="line">csv_file3_object.writerow(right_only_stats)</div></pre></td></tr></table></figure>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">#数据格式</div><div class="line">id	sex	age	WBC	RBC	HGB	HCT	MCV	MCH	MCHC	RDW	PLT	MPV PCT	PDW	LYM	LYM%	MON	MON%	NEU	NEU%	EOS	EOS%	BAS	BAS%	ALY	ALY%	LIC	LIC%</div><div class="line">1	女	6	5.2	7.6	0.176	12.2	2.79	53.6	0.7	13.5	1.41	27.8	0.05	4.93	0.1	0.08	1.6	0.11	2.2	0.06	1.2	138	0.409	83	28	337	11.8	233</div><div class="line">2	女	8	11.2	7.7	0.235	12.2	2.47	22.1	1.1	9.8	7.47	66.7	0.08	4.62	0.7	0.08	0.7	0.09	0.8	0.23	2.1	127	0.376	81	27.5	338	11.6	306</div><div class="line">3	男	9	15	6.8	0.292	9.5	5.15	34.4	1.29	8.6	8.11	54.2	0.27	4.41	1.8	0.15	1	0.17	1.1	0.36	2.4	121	0.348	79	27.5	348	8.5	431</div><div class="line">4	女	9	8.9	7.2	0.225	9.2	2.84	31.8	1.09	12.2	4.88	54.7	0.06	4.12	0.7	0.05	0.6	0.06	0.7	0.18	2.1	121	0.355	86	29.3	340	10	314</div><div class="line">5	女	10	3.7	7.3	0.271	11	1.47	39.5	0.34	9.1	1.78	47.8	0.11	5.06	3	0.02	0.6	0.03	0.7	0.02	0.6	139	0.417	82	27.6	335	12.4	371</div><div class="line">6	男	20	10.4	8.1	0.267	13	3.07	29.6	0.75	7.2	6.05	58.3	0.42	4.91	4	0.09	0.9	0.09	0.8	0.14	1.4	144	0.417	85	29.4	346	10.2	331</div></pre></td></tr></table></figure>
<p> ####逻辑斯特回归<br> 逻辑斯特回归解决一个分类问题。只能解决二分类问题，如果要进行N分类问题，则需要N个分类器。具体的内容主要在这里不介绍。<br> <a href="https://coding.net/u/meishuguo/p/np2016/git/blob/master/sklearn/LR_age.py" target="_blank" rel="external">LR_age.py</a>和<a href="https://coding.net/u/meishuguo/p/np2016/git/blob/master/sklearn/LR_sex.py" target="_blank" rel="external">LR_sex.py</a><br> 使用scikit-learn python库，实现了年龄和性别预测的逻辑斯特回归模型。</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">with open(&apos;dataset/train.csv&apos;, &apos;rb&apos;) as myFile1:</div><div class="line">lines1 = cv.reader(myFile1)</div><div class="line">head1 = lines1.next()</div><div class="line">del head1[0:3]</div><div class="line"># print type(head1)</div><div class="line"># print head1;</div><div class="line">for line in lines1:</div><div class="line"># 对于训练数据删除前三列，其中第二列性别当作标签，0表示男，1表示女</div><div class="line">if line[1].decode(&quot;gbk&quot;).encode(&quot;utf-8&quot;) == &apos;女&apos;:</div><div class="line">y_train.append(0)</div><div class="line">else:</div><div class="line">y_train.append(1)</div><div class="line">x_train.append(line)</div><div class="line">x_train = np.array(x_train)</div><div class="line">x_train = np.delete(x_train, np.s_[0:3], 1)</div><div class="line">y_train = np.array(y_train)</div><div class="line">with open(&apos;dataset/predict.csv&apos;, &apos;rb&apos;) as myFile2:</div><div class="line">lines2 = cv.reader(myFile2)</div><div class="line">head2 = lines2.next()</div><div class="line">for line in lines2:</div><div class="line">if line[1].decode(&quot;gbk&quot;).encode(&quot;utf-8&quot;) == &apos;女&apos;:</div><div class="line">y_test.append(0)</div><div class="line">else:</div><div class="line">y_test.append(1)</div><div class="line">x_test.append(line)</div><div class="line">x_test = np.array(x_test)</div><div class="line">x_test = np.delete(x_test, np.s_[0:3], 1)</div><div class="line">y_test = np.array(y_test)</div><div class="line"># 归一化处理</div><div class="line"># min_max_scaler = preprocessing.MaxAbsScaler()</div><div class="line">min_max_scaler = preprocessing.MinMaxScaler()</div><div class="line">for i in range(26):</div><div class="line">x_test[0:, i] = min_max_scaler.fit_transform(x_test[0:, i])</div><div class="line">x_train[0:, i] = min_max_scaler.fit_transform(x_train[0:, i])</div></pre></td></tr></table></figure>
<p> 将数据整理成所需的格式，输入为26维的numpy.array。使用L1正则化防止过拟合。迭代次数设置为200次，通过linear_model.LogisticRegression.fit函数来训练模型。</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">clf = linear_model.LogisticRegression(C=1.0, penalty=&apos;l1&apos;, tol=1e-6, max_iter=200)</div><div class="line">x_test = x_test.astype(np.float)</div><div class="line">x_train = x_train.astype(np.float)</div><div class="line">y_train = y_train.astype(np.int)</div><div class="line">clf.fit(x_train, y_train)</div><div class="line">print pd.DataFrame(&#123;&quot;columns&quot;: head1, &quot;coef&quot;: list(clf.coef_.T)&#125;)</div><div class="line">predictions = clf.predict(x_test)</div><div class="line">correct_pairs = [(x, y) for (x, y) in zip(y_test, predictions) if x == y]</div><div class="line">precision = float(len(correct_pairs)) / len(x_test)</div><div class="line">print precision</div></pre></td></tr></table></figure>
<p> 同样，对年龄的测试采用同样的做法，只是在判断准确率时，预测误差与实际相差在5以内就算正确。</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">delta=[x1 - x2 for (x1, x2) in zip (y_test, predictions)]</div><div class="line">correct_indices = [x for x in delta if abs(x)&lt;5]</div></pre></td></tr></table></figure>
<p> <strong>逻辑斯特回归是一种浅层学习，相比较于深度学习，它的好处在于我们能够清晰的知道每一项特征与最终结果的关联，能够快速的给予特征工程上的启发。而在深度学习中，我们很难发现每一项之间的关联，调参的难度很大。在性别测试中，我拿到了26项特征对于性别的影响。</strong></p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">coef columns</div><div class="line">0               [0.0]     WBC</div><div class="line">1   [-0.201537934071]     RBC</div><div class="line">2    [-1.56609191156]     HGB</div><div class="line">3   [-0.966680870315]     HCT</div><div class="line">4               [0.0]     MCV</div><div class="line">5    [-1.34449278351]     MCH</div><div class="line">6               [0.0]    MCHC</div><div class="line">7     [2.67399030546]     RDW</div><div class="line">8    [0.554843411227]     PLT</div><div class="line">9    [-1.01595391084]     MPV</div><div class="line">10   [0.980749596616]     PCT</div><div class="line">11   [0.106646248831]     PDW</div><div class="line">12              [0.0]     LYM</div><div class="line">13              [0.0]    LYM%</div><div class="line">14              [0.0]     MON</div><div class="line">15              [0.0]    MON%</div><div class="line">16    [1.64386143402]     NEU</div><div class="line">17              [0.0]    NEU%</div><div class="line">18              [0.0]     EOS</div><div class="line">19    [7.53530847513]    EOS%</div><div class="line">20              [0.0]     BAS</div><div class="line">21    [1.30166526719]    BAS%</div><div class="line">22              [0.0]     ALY</div><div class="line">23              [0.0]    ALY%</div><div class="line">24  [-0.185934731798]     LIC</div><div class="line">25              [0.0]    LIC%</div></pre></td></tr></table></figure>
<p> 这里的特征权重说明，<strong>有些项对于性别的影响几乎没有，有些项是正项影响例如：[7.53530847513]    EOS%  这个特征越大，说明该病人是男性的可能性就会越大。这也是符合我们的常理的。</strong></p>
<p> 对于模型状态的判断，我用sklearn的learning_curve得到training_score和cv_score，使用matplotlib画出learning curve。</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"># 用sklearn的learning_curve得到training_score和cv_score，使用matplotlib画出learning curve</div><div class="line">def plot_learning_curve(estimator, title, X, y, ylim=None, cv=None, n_jobs=1,</div><div class="line">train_sizes=np.linspace(.05, 1., 20), verbose=0, plot=True):</div><div class="line">&quot;&quot;&quot;</div><div class="line">画出data在某模型上的learning curve.</div><div class="line">参数解释</div><div class="line">----------</div><div class="line">estimator : 你用的分类器。</div><div class="line">title : 表格的标题。</div><div class="line">X : 输入的feature，numpy类型</div><div class="line">y : 输入的target vector</div><div class="line">ylim : tuple格式的(ymin, ymax), 设定图像中纵坐标的最低点和最高点</div><div class="line">cv : 做cross-validation的时候，数据分成的份数，其中一份作为cv集，其余n-1份作为training(默认为3份)</div><div class="line">n_jobs : 并行的的任务数(默认1)</div><div class="line">&quot;&quot;&quot;</div><div class="line">train_sizes, train_scores, test_scores = learning_curve(estimator, X, y, cv=cv, n_jobs=n_jobs, train_sizes=train_sizes, verbose=verbose)</div><div class="line">train_scores_mean = np.mean(train_scores, axis=1)</div><div class="line">train_scores_std = np.std(train_scores, axis=1)</div><div class="line">test_scores_mean = np.mean(test_scores, axis=1)</div><div class="line">test_scores_std = np.std(test_scores, axis=1)</div><div class="line">if plot:</div><div class="line">plt.figure()</div><div class="line">plt.title(title)</div><div class="line">if ylim is not None:</div><div class="line">plt.ylim(*ylim)</div><div class="line">plt.xlabel(u&quot;number of train-set&quot;)</div><div class="line">plt.ylabel(u&quot;score&quot;)</div><div class="line">plt.gca().invert_yaxis()</div><div class="line">plt.grid()</div><div class="line">plt.fill_between(train_sizes, train_scores_mean - train_scores_std, train_scores_mean + train_scores_std,</div><div class="line">alpha=0.1, color=&quot;b&quot;)</div><div class="line">plt.fill_between(train_sizes, test_scores_mean - test_scores_std, test_scores_mean + test_scores_std,</div><div class="line">alpha=0.1, color=&quot;r&quot;)</div><div class="line">plt.plot(train_sizes, train_scores_mean, &apos;o-&apos;, color=&quot;b&quot;, label=u&quot;train-set score&quot;)</div><div class="line">plt.plot(train_sizes, test_scores_mean, &apos;o-&apos;, color=&quot;r&quot;, label=u&quot;cv-set score&quot;)</div><div class="line">plt.legend(loc=&quot;best&quot;)</div><div class="line">plt.draw()</div><div class="line">plt.gca().invert_yaxis()</div><div class="line">plt.show()</div><div class="line">midpoint = ((train_scores_mean[-1] + train_scores_std[-1]) + (test_scores_mean[-1] - test_scores_std[-1])) / 2</div><div class="line">diff = (train_scores_mean[-1] + train_scores_std[-1]) - (test_scores_mean[-1] - test_scores_std[-1])</div><div class="line">return midpoint, diff</div></pre></td></tr></table></figure>
<p> 性别模型学习曲线<br> <img src="http://img.blog.csdn.net/20170103215720496?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvdTAxMDQ1NDQzOA==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p> 年龄模型学习曲线<br> <img src="http://img.blog.csdn.net/20170103215751391?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvdTAxMDQ1NDQzOA==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p> 曲线的横坐标是训练集的量，纵坐标为准确率，在训练集不断增大时，交叉验证集和训练集的准确率越来越靠近，最终相差不大，说明模型既没有过拟合，也没有欠拟合。对于年龄预测，完全正确的概率在0.05，性别预测在0.73。<br> 对于200个测试集，年龄预测相差5以内算正确，这样的正确概率为0.15，而性别的正确率反而下降到了0.65，这里我感到很奇怪，交叉验证的模型正确率低于测试集。<br> h</p>
<p> ####深度学习<br> <a href="https://coding.net/u/meishuguo/p/np2016/git/blob/master/Keras/age_predict.py" target="_blank" rel="external">年龄预测</a>和<a href="https://coding.net/u/meishuguo/p/np2016/git/blob/master/Keras/sex_predict.py" target="_blank" rel="external">性别预测</a>使用底层Theano，python接口位keras实现了三层全连接神经网络，输入层维度为26，第一个隐藏层100个节点，采用的激励函数为tanh，dropout参数为0.4（防止过拟合在每次训练中随机屏蔽百分之40的节点），第二个隐藏层100个节点，激励函数和dropout同第一层，输出层为2分类，采用softmax激励函数。经过100次迭代，batch_size为128（每128个数据更新一次权值），在200个测试集上准确率在0.7左右。</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">model = Sequential()</div><div class="line">model.add(Dense(100, input_dim=26,init=&apos;uniform&apos;,activation=&apos;tanh&apos;))</div><div class="line">model.add(Dropout(0.4))</div><div class="line">model.add(Dense(100,init=&apos;uniform&apos;,activation=&apos;tanh&apos;))</div><div class="line">model.add(Dropout(0.4))</div><div class="line">model.add(Dense(100,init=&apos;uniform&apos;))</div><div class="line">model.add(Activation(&apos;softmax&apos;))</div><div class="line">model.summary()</div><div class="line">model.compile(loss=&apos;categorical_crossentropy&apos;,</div><div class="line">optimizer=&apos;Adam&apos;,</div><div class="line">metrics=[&apos;accuracy&apos;])</div><div class="line">model.fit(X_train, Y_train,batch_size=batch_size, nb_epoch=nb_epoch,verbose=1, validation_data=(X_test, Y_test),shuffle=True)</div><div class="line">score = model.evaluate(X_test, Y_test, verbose=0)</div><div class="line">print(&apos;Test score:&apos;, score[0])</div><div class="line">print(&apos;Test accuracy:&apos;, score[1])</div></pre></td></tr></table></figure>
<p> <img src="http://img.blog.csdn.net/20170103221130491?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvdTAxMDQ1NDQzOA==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p> 年龄预测模型和性别测试一样，采用同一种模型得到的结果和逻辑斯特回归一样。都是0.15。性别测试则为0.7。<br> <strong>这说明浅层学习模型已经能够较好的拟和数据，在数据量很小的时候，深度学习的效果和浅层学习的效果几乎一样。</strong></p>
<hr>
<p> ###项目整合<br> 保存模型<br> <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">joblib.dump(model, &apos;model/LR_sex.pkl&apos;)</div></pre></td></tr></table></figure></p>
<p> <a href="https://coding.net/u/meishuguo/p/np2016/git/blob/master/sklearn/sklearn_predict.py" target="_blank" rel="external">读取模型预测</a><br> <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">import numpy as np</div><div class="line">from sklearn.externals import joblib</div><div class="line">def predict(arr):</div><div class="line">#arr=list(arr)</div><div class="line">print arr</div><div class="line">for i in range (4):</div><div class="line">arr.append(0)</div><div class="line">arr=np.array(arr)</div><div class="line">print arr</div><div class="line">print arr.shape</div><div class="line">arr=arr.astype(np.float)</div><div class="line">arr = np.reshape(arr, [1, 26])</div><div class="line">clf_age=joblib.load(&apos;model/LR_age.pkl&apos;)</div><div class="line">clf_sex = joblib.load(&apos;model/LR_sex.pkl&apos;)</div><div class="line">age=clf_age.predict(arr)</div><div class="line">sex=clf_sex.predict(arr)</div><div class="line">return age[0],sex[0]</div></pre></td></tr></table></figure></p>
<p> 这里要说明的是，ocr识别的只有22项数据，模型有26项，我们直接对缺失的项补0，这样这一项表示没有，不会引入<strong>噪声</strong>。</p>
<hr>
<p> ##项目demo<br> 主界面<br> <img src="http://img.blog.csdn.net/20170102235603699?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvdTAxMDQ1NDQzOA==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="图片描述l"></p>
<hr>
<p> 上传报告和识别结果<br> <img src="http://img.blog.csdn.net/20170102235632078?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvdTAxMDQ1NDQzOA==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<hr>
<p> 预测结果<br> <img src="http://img.blog.csdn.net/20170102235922700?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvdTAxMDQ1NDQzOA==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<hr>
<p> #课程学习心得<br> 一开始让我直接上代码，我是拒绝的，在上这门课前，我觉得首先要拥有扎实的理论基础才能很好的完成任务。但是现在，我发现并不是这样，理论加实践，在做的过程中学习，这样的学习是最有效果的。这里在我以前的学习中没有经历过的。</p>
<p> 整个项目我主要对于模型整合方面几乎没有做什么工作，对整个web系统，仅仅是用了其他同学的代码，这是我在接下来需要学习的。</p>
<p> 对于机器学习来说，可能是我学过理论和实践结合最为紧密的一个学科。虽然看似理论的东西居多，但是，真正要实现一个准确率很高的模型。单靠理论是太可行的。理论不能发现数据内在的联系，真正深入到数据内才能有所收获。有了一个idea，实现它，验证是不是真的对模型有提高，人的学习是一个反复学习螺旋上升的过程，同样，模型的学习也是这样，没有一次就能完美的模型。</p>
<p> 整个课程有几点体会。<br> 首先，是代码实现，在作为一个小白程序员实现一个功能时，不要拘泥于代码的质量，实现它，不管用什么方式，在实现的基础上，才能谈的上优化。<br> 第二，立即行动。一个优秀的程序员，在进行合作开发时，commit始终是不会少的，立即行动，当一个新的需求提出时，应该立即着手解决，而不是明天再做。<br> 第三，注重代码维护，代码一定要写注释，不要解释代码是如何工作的，只写做了什么。git 用起来，项目几次工程混乱都是删掉fork 再重新fork，管理好版本库。</p>
<p> 这门课程仅仅是开始，接下来学习机器学习的道路还很长很长。</p>

            <div class="clearfix"></div>
            <hr class="nogutter">
        </div>
        <nav class="pagination" role="pagination">
    
    
</nav>

        <div class="duoshuo">


</div>
    </div>
</section>


      
<!-- ============================ Footer =========================== -->

<footer>
    <div class="container">
            <div class="copy">
                <p>
                    &copy; 2014<script>new Date().getFullYear()>2010&&document.write("-"+new Date().getFullYear());</script>, Content By YuanGuo. All Rights Reserved.
                </p>
                <p>Theme By <a href="//go.kieran.top" style="color: #767D84">Kieran</a></p>
            </div>
            <div class="social">
                <ul>
                    
                    <li><a href="https://github.com/" title="Github" target="_blank"><i class="icon-github"></i></a>&nbsp;</li>
                    
                    
                    <li><a href="https://twitter.com/" title="Twitter" target="_blank"><i class="icon-twitter"></i></a>&nbsp;</li>
                    
                    
                    <li><a href="https://www.facebook.com/" title="Facebook" target="_blank"><i class="icon-facebook"></i></a>&nbsp;</li>
                    
                    
                    <li><a href="https://google.com/" title="Google-Plus" target="_blank"><i class="icon-google-plus"></i></a>&nbsp;</li>
                    
                    
                    <li><a href="http://weibo.com/" title="Sina-Weibo" target="_blank"><i class="icon-sina-weibo"></i></a>&nbsp;</li>
                    
                </ul>
            </div>
            <div class="clearfix"> </div>
        </div>
</footer>

<!-- ============================ END Footer =========================== -->
      <!-- Load our scripts -->
<!-- Resizable 'on-demand' full-height hero -->
<script type="text/javascript">
    var resizeHero = function () {
        var hero = $(".cover,.heightblock"),
            window1 = $(window);
        hero.css({
            "height": window1.height()
        });
    };

    resizeHero();

    $(window).resize(function () {
        resizeHero();
    });
</script>
<script src="/js/plugins.min.js"></script><!-- Bootstrap core and concatenated plugins always load here -->
<script src="/js/jquery.flexslider-min.js"></script><!-- Flexslider plugin -->
<script src="/js/scripts.js"></script><!-- Theme scripts -->


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$('#intro').find('img').each(function(){
  var alt = this.alt;

  if (alt){
    $(this).after('<span class="caption" style="display:none">' + alt + '</span>');
  }

  $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox" rel="gallery" />');
});
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

<!-- Initiate flexslider plugin -->
<script type="text/javascript">
    $(document).ready(function($) {
      (function(){
        console.log('font');
        var getCss = function(path) {
          var head = document.getElementsByTagName('head')[0];
          link = document.createElement('link');
          link.href = path;
          link.rel = 'stylesheet';
          link.type = 'text/css';
          head.appendChild(link);
        };
        getCss('https://fonts.googleapis.com/css?family=Montserrat:400,700');
        getCss('https://fonts.googleapis.com/css?family=Open+Sans:400,600');
      })();
      $('.flexslider').flexslider({
        animation: "fade",
        prevText: "",
        nextText: "",
        directionNav: true
      });
    });
</script>

</body>
</html>
